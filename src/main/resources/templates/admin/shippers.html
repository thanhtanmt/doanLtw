<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/admin}">

<head>
    <title>Quản lý Shipper</title>
</head>

<body>
    <div layout:fragment="page-title">Quản lý Shipper</div>

    <div layout:fragment="content">
        <!-- Stats Overview -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon blue">
                        <i class="fas fa-shipping-fast"></i>
                    </div>
                    <span class="stat-trend up">
                        <i class="fas fa-arrow-up"></i> 8%
                    </span>
                </div>
                <div class="stat-body">
                    <h3 th:text="${totalShippers != null ? totalShippers : 0}">0</h3>
                    <p class="stat-label">Tổng Shipper</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon green">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <span class="stat-trend up">
                        <i class="fas fa-arrow-up"></i> 25%
                    </span>
                </div>
                <div class="stat-body">
                    <h3 th:text="${totalDelivered != null ? totalDelivered : 0}">0</h3>
                    <p class="stat-label">Giao thành công</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon orange">
                        <i class="fas fa-clock"></i>
                    </div>
                    <span class="stat-trend">
                        <i class="fas fa-minus"></i> 0%
                    </span>
                </div>
                <div class="stat-body">
                    <h3 th:text="${totalInProgress != null ? totalInProgress : 0}">0</h3>
                    <p class="stat-label">Đang giao</p>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-header">
                    <div class="stat-icon purple">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <span class="stat-trend down">
                        <i class="fas fa-arrow-down"></i> 3%
                    </span>
                </div>
                <div class="stat-body">
                    <h3 th:text="${totalFailed != null ? totalFailed : 0}">0</h3>
                    <p class="stat-label">Giao thất bại</p>
                </div>
            </div>
        </div>

        <!-- Shipper Performance -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-bar"></i> Hiệu suất Shipper
                </h2>
                <div class="d-flex gap-2">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm shipper...">
                    </div>
                    <select id="statusFilter" class="form-control" style="width: 200px;">
                        <option value="">Tất cả trạng thái</option>
                        <option value="active">Đang hoạt động</option>
                        <option value="inactive">Ngưng hoạt động</option>
                    </select>
                </div>
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Xếp hạng</th>
                                <th>Shipper</th>
                                <th>Liên hệ</th>
                                <th>Tổng đơn</th>
                                <th>Thành công</th>
                                <th>Thất bại</th>
                                <th>Tỷ lệ TC</th>
                                <th>Thu nhập</th>
                                <th>Trạng thái</th>
                                <th>Thao tác</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="shipper, iterStat : ${shippers}">
                                <td>
                                    <strong>#<span th:text="${iterStat.index + 1}">1</span></strong>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-2">
                                        <i class="fas fa-user-circle" style="font-size: 2rem; color: var(--primary-color);"></i>
                                        <div>
                                            <strong th:text="${shipper.fullName}">Full Name</strong>
                                            <br>
                                            <small style="color: var(--text-secondary);" th:text="'ID: ' + ${shipper.shipperId}">ID</small>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <div>
                                        <i class="fas fa-envelope"></i>
                                        <span th:text="${shipper.email}">email@example.com</span>
                                    </div>
                                    <div>
                                        <i class="fas fa-phone"></i>
                                        <span th:text="${shipper.phone}">0123456789</span>
                                    </div>
                                </td>
                                <td>
                                    <strong style="font-size: 1.2rem;" th:text="${shipper.totalOrders}">0</strong> đơn
                                </td>
                                <td>
                                    <strong style="color: var(--success-color);" th:text="${shipper.successOrders}">0</strong>
                                    <br>
                                    <small style="color: var(--text-secondary);">đơn</small>
                                </td>
                                <td>
                                    <strong style="color: var(--danger-color);" th:text="${shipper.failedOrders}">0</strong>
                                    <br>
                                    <small style="color: var(--text-secondary);">đơn</small>
                                </td>
                                <td>
                                    <div class="d-flex align-items-center gap-1">
                                        <div style="width: 60px; height: 8px; background: var(--border-color); border-radius: 4px; overflow: hidden;">
                                            <div th:style="'width: ' + ${shipper.successRate} + '%; height: 100%; background: var(--success-color);'"></div>
                                        </div>
                                        <strong th:text="${shipper.successRate} + '%'">0%</strong>
                                    </div>
                                </td>
                                <td>
                                    <strong style="color: var(--success-color);" 
                                            th:text="${#numbers.formatDecimal(shipper.totalEarnings, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</strong>
                                </td>
                                <td>
                                    <span class="status-badge" 
                                          th:classappend="${shipper.isActive} ? 'active' : 'inactive'"
                                          th:text="${shipper.isActive} ? 'Hoạt động' : 'Ngưng'">
                                        Status
                                    </span>
                                </td>
                                <td>
                                    <div class="d-flex gap-1">
                                        <button class="btn btn-sm btn-info" 
                                                th:onclick="'viewShipperDetails(' + ${shipper.shipperId} + ')'"
                                                title="Xem chi tiết">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-warning" 
                                                th:onclick="'viewShipperOrders(' + ${shipper.shipperId} + ')'"
                                                title="Xem đơn hàng">
                                            <i class="fas fa-list"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${shippers == null or shippers.isEmpty()}">
                                <td colspan="10" class="text-center">
                                    <i class="fas fa-inbox" style="font-size: 3rem; color: var(--text-secondary); margin: 2rem 0;"></i>
                                    <p>Không có shipper nào</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Recent Deliveries -->
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-truck"></i> Đơn hàng gần đây
                </h2>
                <select id="deliveryStatusFilter" class="form-control" style="width: 200px;">
                    <option value="">Tất cả</option>
                    <option value="PENDING">Chờ lấy hàng</option>
                    <option value="PICKED_UP">Đã lấy hàng</option>
                    <option value="IN_TRANSIT">Đang giao</option>
                    <option value="DELIVERED">Đã giao</option>
                    <option value="FAILED">Thất bại</option>
                </select>
            </div>
            <div class="card-body">
                <div class="table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Mã đơn</th>
                                <th>Shipper</th>
                                <th>Khách hàng</th>
                                <th>Địa chỉ giao</th>
                                <th>Giá trị</th>
                                <th>Phí ship</th>
                                <th>Trạng thái</th>
                                <th>Ngày cập nhật</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="delivery : ${recentDeliveries}">
                                <td>
                                    <strong th:text="'#' + ${delivery.orderId}">Order ID</strong>
                                </td>
                                <td th:text="${delivery.shipperName}">Shipper Name</td>
                                <td>
                                    <div>
                                        <strong th:text="${delivery.customerName}">Customer Name</strong>
                                        <br>
                                        <small th:text="${delivery.customerPhone}">Phone</small>
                                    </div>
                                </td>
                                <td>
                                    <small th:text="${delivery.deliveryAddress}">Address</small>
                                </td>
                                <td th:text="${#numbers.formatDecimal(delivery.orderValue, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</td>
                                <td th:text="${#numbers.formatDecimal(delivery.shippingFee, 0, 'COMMA', 0, 'POINT')} + ' đ'">0 đ</td>
                                <td>
                                    <span class="status-badge" 
                                          th:classappend="${delivery.status == 'DELIVERED'} ? 'active' : 
                                                         (${delivery.status == 'FAILED'} ? 'inactive' : 
                                                         (${delivery.status == 'IN_TRANSIT'} ? 'pending' : 'completed'))"
                                          th:text="${delivery.statusText}">
                                        Status
                                    </span>
                                </td>
                                <td th:text="${#temporals.format(delivery.updatedAt, 'dd/MM/yyyy HH:mm')}">Date</td>
                            </tr>
                            <tr th:if="${recentDeliveries == null or recentDeliveries.isEmpty()}">
                                <td colspan="8" class="text-center">Chưa có đơn hàng nào</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Shipper Details Modal -->
        <div id="shipperDetailsModal" class="modal-overlay" style="display: none;">
            <div class="modal" style="max-width: 800px;">
                <div class="modal-header">
                    <h3 class="modal-title">
                        <i class="fas fa-user-circle"></i> Chi tiết Shipper
                    </h3>
                    <button class="modal-close" onclick="closeShipperDetailsModal()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="shipperDetailsContent">
                        <div style="text-align: center; padding: 2rem;">
                            <i class="fas fa-spinner fa-spin" style="font-size: 2rem;"></i>
                            <p>Đang tải...</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="closeShipperDetailsModal()">
                        Đóng
                    </button>
                </div>
            </div>
        </div>

    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                const statusFilter = document.getElementById('statusFilter').value;
                filterShipperTable(searchTerm, statusFilter);
            });

            document.getElementById('statusFilter').addEventListener('change', function(e) {
                const searchTerm = document.getElementById('searchInput').value.toLowerCase();
                const statusFilter = e.target.value;
                filterShipperTable(searchTerm, statusFilter);
            });

            function filterShipperTable(searchTerm, statusFilter) {
                const rows = document.querySelectorAll('tbody tr');
                rows.forEach(row => {
                    if (row.querySelector('td[colspan]')) return;
                    const text = row.textContent.toLowerCase();
                    const matchesSearch = text.includes(searchTerm);
                    const matchesStatus = !statusFilter || 
                        (statusFilter === 'active' && text.includes('hoạt động')) ||
                        (statusFilter === 'inactive' && text.includes('ngưng'));
                    row.style.display = matchesSearch && matchesStatus ? '' : 'none';
                });
            }

            // Delivery status filter
            document.getElementById('deliveryStatusFilter').addEventListener('change', function(e) {
                const status = e.target.value.toLowerCase();
                const rows = document.querySelectorAll('.card:last-of-type tbody tr');
                rows.forEach(row => {
                    if (row.querySelector('td[colspan]')) return;
                    const text = row.textContent.toLowerCase();
                    row.style.display = !status || text.includes(status) ? '' : 'none';
                });
            });

            function viewShipperDetails(shipperId) {
                document.getElementById('shipperDetailsModal').style.display = 'flex';
                
                fetch('/admin/shippers/' + shipperId + '/details')
                    .then(response => response.json())
                    .then(data => {
                        const successRate = data.totalOrders > 0 ? 
                            ((data.successOrders / data.totalOrders) * 100).toFixed(1) : 0;
                        
                        const content = `
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem;">
                                <div class="form-group" style="grid-column: span 2; text-align: center;">
                                    <i class="fas fa-user-circle" style="font-size: 5rem; color: var(--primary-color);"></i>
                                    <h3 style="margin: 0.5rem 0;">${data.fullName}</h3>
                                    <span class="status-badge ${data.isActive ? 'active' : 'inactive'}">
                                        ${data.isActive ? 'Đang hoạt động' : 'Ngưng hoạt động'}
                                    </span>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Email:</label>
                                    <p>${data.email}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Số điện thoại:</label>
                                    <p>${data.phone}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tổng đơn hàng:</label>
                                    <p><strong style="color: var(--info-color); font-size: 1.5rem;">${data.totalOrders}</strong> đơn</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Đơn thành công:</label>
                                    <p><strong style="color: var(--success-color); font-size: 1.5rem;">${data.successOrders}</strong> đơn</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Đơn thất bại:</label>
                                    <p><strong style="color: var(--danger-color); font-size: 1.5rem;">${data.failedOrders}</strong> đơn</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Tỷ lệ thành công:</label>
                                    <p><strong style="color: var(--success-color); font-size: 1.5rem;">${successRate}%</strong></p>
                                </div>
                                <div class="form-group" style="grid-column: span 2;">
                                    <label class="form-label">Tổng thu nhập:</label>
                                    <p><strong style="color: var(--success-color); font-size: 2rem;">${data.totalEarnings.toLocaleString('vi-VN')} đ</strong></p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Ngày đăng ký:</label>
                                    <p>${new Date(data.createdAt).toLocaleString('vi-VN')}</p>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Cập nhật lần cuối:</label>
                                    <p>${new Date(data.updatedAt).toLocaleString('vi-VN')}</p>
                                </div>
                            </div>
                        `;
                        document.getElementById('shipperDetailsContent').innerHTML = content;
                    })
                    .catch(error => {
                        document.getElementById('shipperDetailsContent').innerHTML = `
                            <div class="alert alert-danger">
                                <i class="fas fa-exclamation-circle"></i>
                                Không thể tải thông tin shipper
                            </div>
                        `;
                    });
            }

            function closeShipperDetailsModal() {
                document.getElementById('shipperDetailsModal').style.display = 'none';
            }

            function viewShipperOrders(shipperId) {
                window.location.href = '/admin/shippers/' + shipperId + '/orders';
            }

            // Close modal when clicking outside
            document.getElementById('shipperDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) closeShipperDetailsModal();
            });
        </script>
    </th:block>
</body>
</html>
