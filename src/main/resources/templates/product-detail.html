<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<head>
    <title>Chi tiết sản phẩm</title>
    <style>
        .product-detail-page {
            padding: 40px 0;
        }

        .breadcrumb {
            max-width: 1200px;
            margin: 0 auto 30px;
            padding: 0 20px;
            display: flex;
            gap: 10px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .breadcrumb a {
            color: #667eea;
            text-decoration: none;
        }

        .product-detail-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .product-main {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 60px;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
            margin-bottom: 60px;
        }

        /* Product Gallery */
        .product-gallery {
            position: sticky;
            top: 120px;
            height: fit-content;
        }

        .main-image {
            width: 100%;
            height: 600px;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 20px;
            position: relative;
        }

        .main-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .image-badge {
            position: absolute;
            top: 20px;
            left: 20px;
            background: #ff4757;
            color: white;
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 14px;
        }

        .image-badge.new {
            background: #2ecc71;
        }

        .thumbnail-images {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .thumbnail {
            height: 120px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .thumbnail:hover,
        .thumbnail.active {
            border-color: #667eea;
        }

        .thumbnail img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Product Info */
        .product-info {
            padding-top: 20px;
        }

        .product-category {
            color: #7f8c8d;
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
        }

        .product-title {
            font-size: 32px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.3;
        }

        .product-rating {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 2px solid #f0f0f0;
        }

        .rating-stars {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .stars {
            color: #f39c12;
            font-size: 18px;
        }

        .rating-number {
            font-weight: 600;
            color: #2c3e50;
        }

        .rating-count {
            color: #7f8c8d;
        }

        .product-price {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 25px;
        }

        .current-price {
            font-size: 42px;
            font-weight: 700;
            color: #667eea;
        }

        .old-price {
            font-size: 28px;
            color: #95a5a6;
            text-decoration: line-through;
        }

        .discount-badge {
            background: #ff4757;
            color: white;
            padding: 8px 15px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 16px;
        }

        .product-description {
            color: #555;
            line-height: 1.8;
            margin-bottom: 30px;
            font-size: 15px;
        }

        /* Product Options */
        .product-options {
            margin-bottom: 30px;
        }

        .option-group {
            margin-bottom: 25px;
        }

        .option-label {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
            margin-bottom: 15px;
            display: block;
        }

        .color-options {
            display: flex;
            gap: 15px;
        }

        .color-option {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
            position: relative;
        }

        .color-option:hover,
        .color-option.active {
            border-color: #667eea;
            transform: scale(1.1);
        }

        .color-option.active::after {
            content: '✓';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-weight: 700;
            font-size: 20px;
        }

        .size-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .size-option {
            min-width: 60px;
            padding: 15px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .size-option:hover,
        .size-option.active {
            border-color: #667eea;
            background: #f0f4ff;
            color: #667eea;
        }

        .size-option.out-of-stock {
            opacity: 0.3;
            cursor: not-allowed;
            position: relative;
        }

        .size-option.out-of-stock::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #e74c3c;
            transform: rotate(-15deg);
        }

        /* Quantity Selector */
        .quantity-selector {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
        }

        .quantity-label {
            font-weight: 600;
            font-size: 16px;
            color: #2c3e50;
        }

        .quantity-controls {
            display: flex;
            align-items: center;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .quantity-btn {
            width: 45px;
            height: 50px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 20px;
            font-weight: 600;
            transition: background 0.3s;
        }

        .quantity-btn:hover {
            background: #667eea;
            color: white;
        }

        .quantity-input {
            width: 60px;
            height: 50px;
            border: none;
            text-align: center;
            font-size: 18px;
            font-weight: 600;
        }

        /* Action Buttons */
        .product-actions {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
        }

        .btn-add-cart {
            flex: 1;
            padding: 18px 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-add-cart:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
        }

        .btn-wishlist {
            width: 60px;
            height: 60px;
            border: 2px solid #e0e0e0;
            background: white;
            border-radius: 12px;
            cursor: pointer;
            font-size: 22px;
            transition: all 0.3s;
        }

        .btn-wishlist:hover {
            border-color: #ff4757;
            color: #ff4757;
        }

        .btn-wishlist.active {
            background: #ff4757;
            color: white;
            border-color: #ff4757;
        }

        /* Product Meta */
        .product-meta {
            padding: 25px;
            background: #f8f9fa;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .meta-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .meta-item:last-child {
            border-bottom: none;
        }

        .meta-label {
            color: #7f8c8d;
            font-size: 14px;
        }

        .meta-value {
            font-weight: 600;
            color: #2c3e50;
            font-size: 14px;
        }

        /* Product Features */
        .product-features {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .feature-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .feature-text {
            font-size: 13px;
            font-weight: 500;
            color: #2c3e50;
        }

        /* Tabs */
        .product-tabs {
            margin-top: 60px;
        }

        .tab-buttons {
            display: flex;
            gap: 30px;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 40px;
        }

        .tab-button {
            padding: 15px 0;
            background: none;
            border: none;
            font-size: 16px;
            font-weight: 600;
            color: #7f8c8d;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab-button.active {
            color: #667eea;
        }

        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .tab-content {
            display: none;
            background: white;
            padding: 40px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.08);
        }

        .tab-content.active {
            display: block;
        }

        /* Reviews */
        .reviews-summary {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 40px;
            margin-bottom: 40px;
            padding-bottom: 40px;
            border-bottom: 2px solid #f0f0f0;
        }

        .rating-overview {
            text-align: center;
        }

        .rating-score {
            font-size: 64px;
            font-weight: 700;
            color: #667eea;
            line-height: 1;
        }

        .rating-stars-large {
            color: #f39c12;
            font-size: 24px;
            margin: 15px 0;
        }

        .rating-total {
            color: #7f8c8d;
            font-size: 14px;
        }

        .rating-breakdown {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .rating-bar {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .rating-bar-label {
            min-width: 60px;
            font-size: 14px;
            color: #7f8c8d;
        }

        .rating-bar-fill {
            flex: 1;
            height: 10px;
            background: #f0f0f0;
            border-radius: 5px;
            overflow: hidden;
        }

        .rating-bar-inner {
            height: 100%;
            background: linear-gradient(90deg, #f39c12, #f1c40f);
            transition: width 0.5s;
        }

        .rating-bar-count {
            min-width: 40px;
            text-align: right;
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Review Items */
        .review-item {
            padding: 30px;
            border: 2px solid #f0f0f0;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .reviewer-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .reviewer-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            font-size: 20px;
        }
        
        /* Different avatar colors */
        .reviewer-avatar.color-1 {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .reviewer-avatar.color-2 {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        .reviewer-avatar.color-3 {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        .reviewer-avatar.color-4 {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        .reviewer-avatar.color-5 {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        .reviewer-avatar.color-6 {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        .reviewer-avatar.color-7 {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        }
        .reviewer-avatar.color-8 {
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%);
        }

        .reviewer-name {
            font-weight: 600;
            color: #2c3e50;
        }

        .review-date {
            color: #95a5a6;
            font-size: 13px;
        }

        .review-rating {
            color: #f39c12;
        }

        .review-content {
            color: #555;
            line-height: 1.8;
            margin-bottom: 15px;
        }

        .review-images {
            display: flex;
            gap: 10px;
        }

        .review-image {
            width: 80px;
            height: 80px;
            border-radius: 10px;
            overflow: hidden;
            cursor: pointer;
        }

        .review-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @media (max-width: 1024px) {
            .product-main {
                grid-template-columns: 1fr;
                gap: 40px;
            }

            .product-gallery {
                position: relative;
                top: 0;
            }
        }

        @media (max-width: 768px) {
            .product-title {
                font-size: 24px;
            }

            .current-price {
                font-size: 32px;
            }

            .product-features {
                grid-template-columns: 1fr;
            }

            .reviews-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div layout:fragment="content">
        <div class="product-detail-page">
            <!-- Loading State -->
            <div id="loadingState" style="text-align: center; padding: 100px 0;">
                <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #667eea;"></i>
                <p style="margin-top: 20px; color: #7f8c8d;">Đang tải thông tin sản phẩm...</p>
            </div>

            <!-- Product Container (will be populated by JavaScript) -->
            <div id="productContainer" style="display: none;"></div>
            
            <!-- Error State -->
            <div id="errorState" style="display: none; text-align: center; padding: 100px 0;">
                <i class="fas fa-exclamation-triangle" style="font-size: 48px; color: #e74c3c;"></i>
                <p style="margin-top: 20px; color: #7f8c8d;">Không tìm thấy sản phẩm!</p>
                <a href="/" class="btn" style="margin-top: 20px; display: inline-block; background: #667eea; color: white; padding: 12px 30px; border-radius: 25px; text-decoration: none;">
                    <i class="fas fa-home"></i> Về trang chủ
                </a>
            </div>
        </div>
    </div>
                <!-- Product Main -->
                <div class="product-main">
                    <!-- Gallery -->
                    <div class="product-gallery">
                        <div class="main-image">
                            <span class="image-badge">-30%</span>
                            <img src="https://images.unsplash.com/photo-1620799140188-3b2a02fd9a77?w=800" alt="Product" id="mainImage">
                        </div>
                        <div class="thumbnail-images">
                            <div class="thumbnail active">
                                <img src="https://images.unsplash.com/photo-1620799140188-3b2a02fd9a77?w=200" alt="Thumb 1">
                            </div>
                            <div class="thumbnail">
                                <img src="https://images.unsplash.com/photo-1583743814966-8936f5b7be1a?w=200" alt="Thumb 2">
                            </div>
                            <div class="thumbnail">
                                <img src="https://images.unsplash.com/photo-1618354691373-d851c5c3a990?w=200" alt="Thumb 3">
                            </div>
                            <div class="thumbnail">
                                <img src="https://images.unsplash.com/photo-1622445275463-afa2ab738c34?w=200" alt="Thumb 4">
                            </div>
                        </div>
                    </div>

                    <!-- Info -->
                    <div class="product-info">
                        <div class="product-category">ÁO THUN NAM</div>
                        <h1 class="product-title">Áo Thun Cotton Cao Cấp Form Slim Fit</h1>

                        <div class="product-rating">
                            <div class="rating-stars">
                                <span class="stars">
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star"></i>
                                    <i class="fas fa-star-half-alt"></i>
                                </span>
                                <span class="rating-number">4.5</span>
                            </div>
                            <span class="rating-count">(128 đánh giá)</span>
                            <span style="color: #2ecc71; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Còn hàng
                            </span>
                        </div>

                        <div class="product-price">
                            <span class="current-price">350.000đ</span>
                            <span class="old-price">500.000đ</span>
                            <span class="discount-badge">-30%</span>
                        </div>

                        <p class="product-description">
                            Áo thun cotton cao cấp với chất liệu vải mềm mại, thoáng mát, thấm hút mồ hôi tốt. 
                            Thiết kế form slim fit ôm vừa vặn, tôn dáng người mặc. Phù hợp cho cả hoạt động thể thao 
                            và mặc hàng ngày.
                        </p>

                        <!-- Options -->
                        <div class="product-options">
                            <!-- Colors -->
                            <div class="option-group">
                                <label class="option-label">Màu sắc: <span style="color: #667eea;">Đen</span></label>
                                <div class="color-options">
                                    <div class="color-option active" style="background: #000000;"></div>
                                    <div class="color-option" style="background: #FFFFFF; border: 1px solid #ddd;"></div>
                                    <div class="color-option" style="background: #1e3a8a;"></div>
                                    <div class="color-option" style="background: #16a34a;"></div>
                                    <div class="color-option" style="background: #dc2626;"></div>
                                </div>
                            </div>

                            <!-- Sizes -->
                            <div class="option-group">
                                <label class="option-label">Kích thước: <span style="color: #667eea;">M</span></label>
                                <div class="size-options">
                                    <div class="size-option">S</div>
                                    <div class="size-option active">M</div>
                                    <div class="size-option">L</div>
                                    <div class="size-option">XL</div>
                                    <div class="size-option out-of-stock">2XL</div>
                                </div>
                            </div>
                        </div>

                        <!-- Quantity -->
                        <div class="quantity-selector">
                            <span class="quantity-label">Số lượng:</span>
                            <div class="quantity-controls">
                                <button class="quantity-btn" id="decreaseBtn">−</button>
                                <input type="number" class="quantity-input" value="1" min="1" id="quantityInput">
                                <button class="quantity-btn" id="increaseBtn">+</button>
                            </div>
                        </div>

                        <!-- Actions -->
                        <div class="product-actions">
                            <button class="btn-add-cart">
                                <i class="fas fa-shopping-cart"></i>
                                THÊM VÀO GIỎ HÀNG
                            </button>
                            <button class="btn-wishlist" th:attr="data-product-id=${product.id}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>

                        <!-- Meta -->
                        <div class="product-meta">
                            <div class="meta-item">
                                <span class="meta-label">SKU:</span>
                                <span class="meta-value">TSH-001</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Danh mục:</span>
                                <span class="meta-value">Áo Thun Nam</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Thương hiệu:</span>
                                <span class="meta-value">Fashion Store</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Chất liệu:</span>
                                <span class="meta-value">100% Cotton</span>
                            </div>
                        </div>

                        <!-- Features -->
                        <div class="product-features">
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-shipping-fast"></i>
                                </div>
                                <span class="feature-text">Giao hàng miễn phí</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-undo-alt"></i>
                                </div>
                                <span class="feature-text">Đổi trả trong 7 ngày</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-shield-alt"></i>
                                </div>
                                <span class="feature-text">Bảo hành chính hãng</span>
                            </div>
                            <div class="feature-item">
                                <div class="feature-icon">
                                    <i class="fas fa-headset"></i>
                                </div>
                                <span class="feature-text">Hỗ trợ 24/7</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="product-tabs">
                    <div class="tab-buttons">
                        <button class="tab-button active" data-tab="description">MÔ TẢ</button>
                        <button class="tab-button" data-tab="specifications">THÔNG SỐ</button>
                        <button class="tab-button" data-tab="reviews" 
                                th:text="'ĐÁNH GIÁ (' + ${reviewStats.totalReviews != null ? reviewStats.totalReviews : 0} + ')'">ĐÁNH GIÁ (0)</button>
                    </div>

                    <!-- Description Tab -->
                    <div class="tab-content active" id="description">
                        <h3 style="margin-bottom: 20px;">Mô Tả Sản Phẩm</h3>
                        <p style="line-height: 1.8; color: #555;">
                            <strong>Áo Thun Cotton Cao Cấp Form Slim Fit</strong> là sự lựa chọn hoàn hảo cho những ai yêu thích 
                            sự thoải mái và phong cách hiện đại. Được làm từ 100% cotton cao cấp, sản phẩm mang đến cảm giác 
                            mềm mại, thoáng mát và thấm hút mồ hôi tốt.
                        </p>
                        <p style="line-height: 1.8; color: #555; margin-top: 15px;">
                            <strong>Đặc điểm nổi bật:</strong>
                        </p>
                        <ul style="line-height: 2; color: #555; margin-left: 25px;">
                            <li>Chất liệu cotton 100% cao cấp, mềm mại và thoáng mát</li>
                            <li>Form slim fit ôm vừa vặn, tôn dáng người mặc</li>
                            <li>Đường may tỉ mỉ, chắc chắn</li>
                            <li>Dễ dàng phối đồ với nhiều trang phục khác nhau</li>
                            <li>Màu sắc bền đẹp, không phai sau nhiều lần giặt</li>
                        </ul>
                    </div>

                    <!-- Specifications Tab -->
                    <div class="tab-content" id="specifications">
                        <h3 style="margin-bottom: 20px;">Thông Số Sản Phẩm</h3>
                        <table style="width: 100%; border-collapse: collapse;">
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d; width: 30%;">Chất liệu</td>
                                <td style="padding: 15px 0; font-weight: 600;">100% Cotton</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d;">Form dáng</td>
                                <td style="padding: 15px 0; font-weight: 600;">Slim Fit</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d;">Xuất xứ</td>
                                <td style="padding: 15px 0; font-weight: 600;">Việt Nam</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d;">Kiểu cổ áo</td>
                                <td style="padding: 15px 0; font-weight: 600;">Cổ tròn</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d;">Kiểu tay áo</td>
                                <td style="padding: 15px 0; font-weight: 600;">Tay ngắn</td>
                            </tr>
                            <tr style="border-bottom: 1px solid #f0f0f0;">
                                <td style="padding: 15px 0; color: #7f8c8d;">Độ dày</td>
                                <td style="padding: 15px 0; font-weight: 600;">Vừa phải</td>
                            </tr>
                            <tr>
                                <td style="padding: 15px 0; color: #7f8c8d;">Hướng dẫn bảo quản</td>
                                <td style="padding: 15px 0; font-weight: 600;">Giặt máy, không dùng chất tẩy</td>
                            </tr>
                        </table>
                    </div>

                    <!-- Reviews Tab -->
                    <div class="tab-content" id="reviews">
                        <div class="reviews-summary">
                            <div class="rating-overview">
                                <div class="rating-score" th:text="${reviewStats.averageRating != null ? #numbers.formatDecimal(reviewStats.averageRating, 1, 1) : '0.0'}">0.0</div>
                                <div class="rating-stars-large">
                                    <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                        <i th:if="${reviewStats.averageRating != null && i <= reviewStats.averageRating}" class="fas fa-star"></i>
                                        <i th:if="${reviewStats.averageRating != null && i > reviewStats.averageRating && i - 0.5 <= reviewStats.averageRating}" class="fas fa-star-half-alt"></i>
                                        <i th:if="${reviewStats.averageRating == null || i - 0.5 > reviewStats.averageRating}" class="far fa-star"></i>
                                    </th:block>
                                </div>
                                <div class="rating-total" th:text="${reviewStats.totalReviews != null ? reviewStats.totalReviews : 0} + ' đánh giá'">0 đánh giá</div>
                            </div>

                            <div class="rating-breakdown">
                                <div class="rating-bar">
                                    <span class="rating-bar-label">5 sao</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-inner" 
                                             th:style="${reviewStats.totalReviews != null && reviewStats.totalReviews > 0 ? 'width: ' + (reviewStats.fiveStar * 100.0 / reviewStats.totalReviews) + '%;' : 'width: 0%;'}"></div>
                                    </div>
                                    <span class="rating-bar-count" th:text="${reviewStats.fiveStar != null ? reviewStats.fiveStar : 0}">0</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-bar-label">4 sao</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-inner" 
                                             th:style="${reviewStats.totalReviews != null && reviewStats.totalReviews > 0 ? 'width: ' + (reviewStats.fourStar * 100.0 / reviewStats.totalReviews) + '%;' : 'width: 0%;'}"></div>
                                    </div>
                                    <span class="rating-bar-count" th:text="${reviewStats.fourStar != null ? reviewStats.fourStar : 0}">0</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-bar-label">3 sao</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-inner" 
                                             th:style="${reviewStats.totalReviews != null && reviewStats.totalReviews > 0 ? 'width: ' + (reviewStats.threeStar * 100.0 / reviewStats.totalReviews) + '%;' : 'width: 0%;'}"></div>
                                    </div>
                                    <span class="rating-bar-count" th:text="${reviewStats.threeStar != null ? reviewStats.threeStar : 0}">0</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-bar-label">2 sao</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-inner" 
                                             th:style="${reviewStats.totalReviews != null && reviewStats.totalReviews > 0 ? 'width: ' + (reviewStats.twoStar * 100.0 / reviewStats.totalReviews) + '%;' : 'width: 0%;'}"></div>
                                    </div>
                                    <span class="rating-bar-count" th:text="${reviewStats.twoStar != null ? reviewStats.twoStar : 0}">0</span>
                                </div>
                                <div class="rating-bar">
                                    <span class="rating-bar-label">1 sao</span>
                                    <div class="rating-bar-fill">
                                        <div class="rating-bar-inner" 
                                             th:style="${reviewStats.totalReviews != null && reviewStats.totalReviews > 0 ? 'width: ' + (reviewStats.oneStar * 100.0 / reviewStats.totalReviews) + '%;' : 'width: 0%;'}"></div>
                                    </div>
                                    <span class="rating-bar-count" th:text="${reviewStats.oneStar != null ? reviewStats.oneStar : 0}">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Reviews List from Database -->
                        <div th:if="${reviews != null && !reviews.isEmpty()}">
                            <div class="review-item" th:each="review : ${reviews}">
                                <div class="review-header">
                                    <div class="reviewer-info">
                                        <div class="reviewer-avatar" 
                                             th:text="${review['user'] != null && review['user']['fullName'] != null && #strings.length(review['user']['fullName']) > 0 ? #strings.substring(review['user']['fullName'], 0, 1).toUpperCase() : 'U'}">U</div>
                                        <div>
                                            <div class="reviewer-name" 
                                                 th:text="${review['user'] != null && review['user']['fullName'] != null ? review['user']['fullName'] : 'Người dùng'}">Người dùng</div>
                                            <div class="review-date" 
                                                 th:text="${review['createdAt'] != null ? #temporals.format(review['createdAt'], 'dd/MM/yyyy') : ''}">01/01/2025</div>
                                        </div>
                                    </div>
                                    <div class="review-rating">
                                        <th:block th:each="i : ${#numbers.sequence(1, 5)}">
                                            <i th:if="${i <= review['rating']}" class="fas fa-star"></i>
                                            <i th:if="${i > review['rating']}" class="far fa-star"></i>
                                        </th:block>
                                    </div>
                                </div>
                                <div class="review-content" 
                                     th:text="${review['comment'] != null && #strings.length(review['comment']) > 0 ? review['comment'] : 'Không có nhận xét'}">
                                    Sản phẩm rất tốt!
                                </div>
                            </div>
                        </div>

                        <!-- No Reviews Message -->
                        <div th:if="${reviews == null || reviews.isEmpty()}" 
                             style="text-align: center; padding: 60px 20px; color: #7f8c8d;">
                            <i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 20px; opacity: 0.3;"></i>
                            <p style="font-size: 18px; font-weight: 600; margin-bottom: 10px;">Chưa có đánh giá nào</p>
                            <p style="font-size: 14px;">Hãy là người đầu tiên đánh giá sản phẩm này!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Image gallery
        document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
            thumb.addEventListener('click', function() {
                document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                const img = this.querySelector('img').src.replace('w=200', 'w=800');
                document.getElementById('mainImage').src = img;
            });
        });

        // Color selection
        document.querySelectorAll('.color-option').forEach(color => {
            color.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Size selection
        document.querySelectorAll('.size-option:not(.out-of-stock)').forEach(size => {
            size.addEventListener('click', function() {
                document.querySelectorAll('.size-option').forEach(s => s.classList.remove('active'));
                this.classList.add('active');
            });
        });

        // Quantity controls
        const quantityInput = document.getElementById('quantityInput');
        if (quantityInput) {
            document.getElementById('decreaseBtn')?.addEventListener('click', () => {
                if (quantityInput.value > 1) quantityInput.value--;
            });
            document.getElementById('increaseBtn')?.addEventListener('click', () => {
                quantityInput.value++;
            });
        }

        // Wishlist toggle
        const wishlistBtn = document.querySelector('.btn-wishlist');
        if (wishlistBtn) {
            wishlistBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                const icon = this.querySelector('i');
                icon.classList.toggle('far');
                icon.classList.toggle('fas');
            });
        }

        // Add to cart
        const addCartBtn = document.querySelector('.btn-add-cart');
        if (addCartBtn) {
            addCartBtn.addEventListener('click', function() {
                this.innerHTML = '<i class="fas fa-check"></i> ĐÃ THÊM VÀO GIỎ';
                setTimeout(() => {
                    this.innerHTML = '<i class="fas fa-shopping-cart"></i> THÊM VÀO GIỎ HÀNG';
                }, 2000);
            });
        }

        // Tabs
        document.querySelectorAll('.tab-button').forEach(button => {
            button.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });
        
        // Add random colors to reviewer avatars
        document.addEventListener('DOMContentLoaded', function() {
            const avatars = document.querySelectorAll('.reviewer-avatar');
            avatars.forEach((avatar, index) => {
                const colorClass = 'color-' + ((index % 8) + 1);
                avatar.classList.add(colorClass);
            });
        });
    </script>
</body>
</html>

<!-- Scripts Fragment -->
<th:block layout:fragment="scripts">
    <!-- Include cart.js for add to cart functionality -->
    <script th:src="@{/js/cart.js}"></script>
    <script>
        // Get product ID from URL
        function getProductIdFromUrl() {
            const path = window.location.pathname;
            const matches = path.match(/\/product\/(\d+)/);
            return matches ? matches[1] : null;
        }

        // Format price
        function formatPrice(price) {
            if (!price) return '0đ';
            return new Intl.NumberFormat('vi-VN').format(price) + 'đ';
        }

        // Generate stars HTML
        function generateStars(rating) {
            let html = '';
            const fullStars = Math.floor(rating);
            const hasHalfStar = rating % 1 >= 0.5;
            const emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);
            
            for (let i = 0; i < fullStars; i++) {
                html += '<i class="fas fa-star"></i>';
            }
            if (hasHalfStar) {
                html += '<i class="fas fa-star-half-alt"></i>';
            }
            for (let i = 0; i < emptyStars; i++) {
                html += '<i class="far fa-star"></i>';
            }
            
            return html;
        }

        // Load product data from API
        async function loadProductDetail() {
            const productId = getProductIdFromUrl();
            
            if (!productId) {
                showError();
                return;
            }

            try {
                const response = await fetch(`http://localhost:8080/api/products/${productId}`);
                const data = await response.json();
                
                if (data.success && data.data) {
                    renderProductDetail(data.data);
                } else {
                    showError();
                }
            } catch (error) {
                console.error('Error loading product:', error);
                showError();
            }
        }

        // Render product detail
        function renderProductDetail(product) {
            const container = document.getElementById('productContainer');
            
            // Store product globally for cart functionality
            window.currentProduct = product;
            
            // Get primary image
            let primaryImage = 'https://images.unsplash.com/photo-1620799140188-3b2a02fd9a77?w=800';
            if (product.images && product.images.length > 0) {
                const primary = product.images.find(img => img.isPrimary) || product.images[0];
                primaryImage = primary.url;
            }

            // Calculate discount percentage
            let discountBadge = '';
            let discountPercent = '';
            if (product.minPrice && product.maxPrice && product.minPrice < product.maxPrice) {
                const discount = Math.round(((product.maxPrice - product.minPrice) / product.maxPrice) * 100);
                discountBadge = `<span class="image-badge">-${discount}%</span>`;
                discountPercent = `<span class="discount-badge">-${discount}%</span>`;
            } else if (product.hasStock) {
                discountBadge = '<span class="image-badge new">NEW</span>';
            }

            // Generate thumbnails
            let thumbnailsHTML = '';
            if (product.images && product.images.length > 0) {
                thumbnailsHTML = product.images.map((img, index) => `
                    <div class="thumbnail ${index === 0 ? 'active' : ''}">
                        <img src="${img.url}" alt="Thumb ${index + 1}">
                    </div>
                `).join('');
            }

            // Generate variants (colors and sizes)
            let colorsHTML = '';
            let sizesHTML = '';
            if (product.variants && product.variants.length > 0) {
                const uniqueColors = [...new Set(product.variants.map(v => v.color))];
                const uniqueSizes = [...new Set(product.variants.map(v => v.size))];

                colorsHTML = uniqueColors.map((color, index) => {
                    const colorHex = getColorHex(color);
                    return `<div class="color-option ${index === 0 ? 'active' : ''}" style="background: ${colorHex};" data-color="${color}"></div>`;
                }).join('');

                sizesHTML = uniqueSizes.map((size, index) => {
                    const variant = product.variants.find(v => v.size === size);
                    const outOfStock = !variant || variant.quantity <= 0;
                    return `<div class="size-option ${index === 0 && !outOfStock ? 'active' : ''} ${outOfStock ? 'out-of-stock' : ''}" data-size="${size}">${size}</div>`;
                }).join('');
            }

            // Price HTML
            const priceHTML = product.minPrice === product.maxPrice
                ? `<span class="current-price">${formatPrice(product.minPrice)}</span>`
                : `
                    <span class="current-price">${formatPrice(product.minPrice)}</span>
                    <span class="old-price">${formatPrice(product.maxPrice)}</span>
                    ${discountPercent}
                `;

            // Generate HTML
            const html = `
                <!-- Breadcrumb -->
                <div class="breadcrumb">
                    <a href="/"><i class="fas fa-home"></i> Trang chủ</a>
                    <span>/</span>
                    <a href="/products">Sản phẩm</a>
                    <span>/</span>
                    <span>${product.name}</span>
                </div>

                <div class="product-detail-container">
                    <!-- Product Main -->
                    <div class="product-main">
                        <!-- Gallery -->
                        <div class="product-gallery">
                            <div class="main-image">
                                ${discountBadge}
                                <img src="${primaryImage}" alt="${product.name}" id="mainImage">
                            </div>
                            <div class="thumbnail-images">
                                ${thumbnailsHTML}
                            </div>
                        </div>

                        <!-- Info -->
                        <div class="product-info">
                            <div class="product-category">${product.categoryName || 'SẢN PHẨM'}</div>
                            <h1 class="product-title">${product.name}</h1>

                            <div class="product-rating">
                                <div class="rating-stars">
                                    <span class="stars">${generateStars(product.averageRating || 0)}</span>
                                    <span class="rating-number">${(product.averageRating || 0).toFixed(1)}</span>
                                </div>
                                <span class="rating-count">(${product.totalReviews || 0} đánh giá)</span>
                                <span style="color: ${product.hasStock ? '#2ecc71' : '#e74c3c'}; font-weight: 600;">
                                    <i class="fas ${product.hasStock ? 'fa-check-circle' : 'fa-times-circle'}"></i> 
                                    ${product.hasStock ? 'Còn hàng' : 'Hết hàng'}
                                </span>
                            </div>

                            <div class="product-price">
                                ${priceHTML}
                            </div>

                            <p class="product-description">
                                ${product.description || 'Sản phẩm chất lượng cao, thiết kế hiện đại, phù hợp cho mọi lứa tuổi.'}
                            </p>

                            <!-- Options -->
                            <div class="product-options">
                                ${colorsHTML ? `
                                <div class="option-group">
                                    <label class="option-label">Màu sắc: <span style="color: #667eea;" id="selectedColor">Chọn màu</span></label>
                                    <div class="color-options">
                                        ${colorsHTML}
                                    </div>
                                </div>
                                ` : ''}

                                ${sizesHTML ? `
                                <div class="option-group">
                                    <label class="option-label">Kích thước: <span style="color: #667eea;" id="selectedSize">Chọn size</span></label>
                                    <div class="size-options">
                                        ${sizesHTML}
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- Quantity -->
                            <div class="quantity-selector">
                                <span class="quantity-label">Số lượng:</span>
                                <div class="quantity-controls">
                                    <button class="quantity-btn" id="decreaseBtn">−</button>
                                    <input type="number" class="quantity-input" value="1" min="1" id="quantityInput">
                                    <button class="quantity-btn" id="increaseBtn">+</button>
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="product-actions">
                                <button class="btn-add-cart" ${!product.hasStock ? 'disabled style="background: #95a5a6; cursor: not-allowed;"' : ''}>
                                    <i class="fas fa-shopping-cart"></i>
                                    ${product.hasStock ? 'THÊM VÀO GIỎ HÀNG' : 'HẾT HÀNG'}
                                </button>
                                <button class="btn-wishlist">
                                    <i class="far fa-heart"></i>
                                </button>
                            </div>

                            <!-- Meta -->
                            <div class="product-meta">
                                <div class="meta-item">
                                    <span class="meta-label">SKU:</span>
                                    <span class="meta-value">${product.sku || 'N/A'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Danh mục:</span>
                                    <span class="meta-value">${product.categoryName || 'N/A'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Thương hiệu:</span>
                                    <span class="meta-value">${product.brand || 'Fashion Store'}</span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Tình trạng:</span>
                                    <span class="meta-value">${product.hasStock ? 'Còn hàng' : 'Hết hàng'}</span>
                                </div>
                            </div>

                            <!-- Features -->
                            <div class="product-features">
                                <div class="feature-item">
                                    <div class="feature-icon">
                                        <i class="fas fa-shipping-fast"></i>
                                    </div>
                                    <span class="feature-text">Giao hàng miễn phí</span>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon">
                                        <i class="fas fa-undo-alt"></i>
                                    </div>
                                    <span class="feature-text">Đổi trả trong 7 ngày</span>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon">
                                        <i class="fas fa-certificate"></i>
                                    </div>
                                    <span class="feature-text">Hàng chính hãng 100%</span>
                                </div>
                                <div class="feature-item">
                                    <div class="feature-icon">
                                        <i class="fas fa-headset"></i>
                                    </div>
                                    <span class="feature-text">Hỗ trợ 24/7</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="product-tabs">
                        <div class="tab-buttons">
                            <button class="tab-button active" data-tab="description">Mô tả</button>
                            <button class="tab-button" data-tab="specifications">Thông số</button>
                            <button class="tab-button" data-tab="reviews">Đánh giá (${product.totalReviews || 0})</button>
                        </div>

                        <div class="tab-content active" id="description">
                            <h3 style="margin-bottom: 20px; color: #2c3e50;">Mô tả sản phẩm</h3>
                            <div style="line-height: 1.8; color: #555;">
                                ${product.description || 'Sản phẩm chất lượng cao từ Fashion Store với chất liệu tốt nhất, thiết kế hiện đại và phong cách thời trang.'}
                            </div>
                        </div>

                        <div class="tab-content" id="specifications">
                            <h3 style="margin-bottom: 20px; color: #2c3e50;">Thông số kỹ thuật</h3>
                            <table style="width: 100%; border-collapse: collapse;">
                                <tbody>
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50; width: 200px;">Mã sản phẩm</td>
                                        <td style="padding: 15px; color: #555;">${product.sku || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Danh mục</td>
                                        <td style="padding: 15px; color: #555;">${product.categoryName || 'N/A'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Thương hiệu</td>
                                        <td style="padding: 15px; color: #555;">${product.brand || 'Fashion Store'}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Xuất xứ</td>
                                        <td style="padding: 15px; color: #555;">Việt Nam</td>
                                    </tr>
                                    ${product.variants && product.variants.length > 0 ? `
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Màu sắc</td>
                                        <td style="padding: 15px; color: #555;">${[...new Set(product.variants.map(v => v.color))].join(', ')}</td>
                                    </tr>
                                    <tr style="border-bottom: 1px solid #e0e0e0; background: #f8f9fa;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Kích thước</td>
                                        <td style="padding: 15px; color: #555;">${[...new Set(product.variants.map(v => v.size))].join(', ')}</td>
                                    </tr>
                                    ` : ''}
                                    <tr style="border-bottom: 1px solid #e0e0e0;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Tình trạng</td>
                                        <td style="padding: 15px; color: ${product.hasStock ? '#2ecc71' : '#e74c3c'}; font-weight: 600;">
                                            ${product.hasStock ? '✓ Còn hàng' : '✗ Hết hàng'}
                                        </td>
                                    </tr>
                                    <tr style="background: #f8f9fa;">
                                        <td style="padding: 15px; font-weight: 600; color: #2c3e50;">Chất liệu</td>
                                        <td style="padding: 15px; color: #555;">Cotton cao cấp, thoáng mát</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="tab-content" id="reviews">
                            <h3 style="margin-bottom: 30px; color: #2c3e50;">Đánh giá từ khách hàng</h3>
                            
                            <!-- Reviews Section -->
                            <div id="reviewsSection">
                                <div style="text-align: center; padding: 40px 0; color: #7f8c8d;">
                                    <i class="fas fa-spinner fa-spin" style="font-size: 32px;"></i>
                                    <p style="margin-top: 15px;">Đang tải đánh giá...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = html;
            document.getElementById('loadingState').style.display = 'none';
            container.style.display = 'block';

            // Load reviews from API
            loadProductReviews(product.id);

            // Re-attach event listeners
            attachEventListeners();
        }

        // Get color hex from color name
        function getColorHex(colorName) {
            const colors = {
                'Đen': '#000000',
                'Trắng': '#FFFFFF',
                'Xanh': '#1e3a8a',
                'Đỏ': '#dc2626',
                'Xanh lá': '#16a34a',
                'Vàng': '#facc15',
                'Hồng': '#ec4899',
                'Xám': '#6b7280',
                'Nâu': '#92400e'
            };
            return colors[colorName] || '#667eea';
        }

        // Generate rating bars
        function generateRatingBars(totalReviews) {
            // Simulate rating distribution
            const distribution = [
                { stars: 5, percent: 70 },
                { stars: 4, percent: 20 },
                { stars: 3, percent: 6 },
                { stars: 2, percent: 3 },
                { stars: 1, percent: 1 }
            ];

            return distribution.map(item => {
                const count = Math.round((totalReviews * item.percent) / 100);
                return `
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <span style="min-width: 80px; font-size: 14px; color: #7f8c8d;">
                            ${item.stars} <i class="fas fa-star" style="color: #f39c12;"></i>
                        </span>
                        <div style="flex: 1; height: 10px; background: #f0f0f0; border-radius: 5px; overflow: hidden;">
                            <div style="height: 100%; width: ${item.percent}%; background: linear-gradient(90deg, #f39c12, #f1c40f); transition: width 0.5s;"></div>
                        </div>
                        <span style="min-width: 50px; text-align: right; font-size: 14px; color: #7f8c8d; font-weight: 600;">
                            ${count}
                        </span>
                    </div>
                `;
            }).join('');
        }

        // Generate sample reviews
        function generateSampleReviews(averageRating) {
            // This function is deprecated - reviews now loaded from API
            return '';
        }
        
        // Load product reviews from API
        async function loadProductReviews(productId) {
            const reviewsSection = document.getElementById('reviewsSection');
            
            try {
                const response = await fetch(`/api/reviews/product/${productId}`);
                const data = await response.json();
                
                if (data.success) {
                    renderReviews(data.reviews, data.stats);
                } else {
                    renderNoReviews();
                }
            } catch (error) {
                console.error('Error loading reviews:', error);
                renderNoReviews();
            }
        }
        
        // Render reviews
        function renderReviews(reviews, stats) {
            const reviewsSection = document.getElementById('reviewsSection');
            const avatarColors = [
                'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)'
            ];
            
            let html = '';
            
            // Reviews Summary
            if (stats && stats.totalReviews > 0) {
                html += `
                <div style="display: grid; grid-template-columns: 250px 1fr; gap: 40px; margin-bottom: 40px; padding-bottom: 40px; border-bottom: 2px solid #f0f0f0;">
                    <div style="text-align: center; background: #f8f9fa; padding: 30px; border-radius: 15px;">
                        <div style="font-size: 64px; font-weight: 700; color: #667eea; line-height: 1;">
                            ${stats.averageRating.toFixed(1)}
                        </div>
                        <div style="color: #f39c12; font-size: 24px; margin: 15px 0;">
                            ${generateStars(stats.averageRating)}
                        </div>
                        <div style="color: #7f8c8d; font-size: 14px;">
                            ${stats.totalReviews} đánh giá
                        </div>
                    </div>
                    
                    <div style="display: flex; flex-direction: column; gap: 12px; justify-content: center;">
                        ${generateRatingBarsFromStats(stats)}
                    </div>
                </div>
                `;
            }
            
            // Reviews List
            if (reviews && reviews.length > 0) {
                html += '<div style="display: flex; flex-direction: column; gap: 20px;">';
                reviews.forEach((review, index) => {
                    const avatarColor = avatarColors[index % avatarColors.length];
                    const userName = review.user && review.user.fullName ? review.user.fullName : 'Người dùng';
                    const userInitial = userName.charAt(0).toUpperCase();
                    const reviewDate = review.createdAt ? new Date(review.createdAt).toLocaleDateString('vi-VN') : '';
                    const comment = review.comment || 'Không có nhận xét';
                    const images = review.images || [];
                    const videos = review.videos || [];
                    
                    // Generate media HTML
                    let mediaHTML = '';
                    if (images.length > 0 || videos.length > 0) {
                        mediaHTML = '<div style="margin-top: 15px; display: flex; gap: 10px; flex-wrap: wrap;">';
                        
                        // Images
                        images.forEach(imageUrl => {
                            mediaHTML += `
                                <div style="width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; cursor: pointer;" onclick="openImageLightbox('${imageUrl}')">
                                    <img src="${imageUrl}" alt="Review image" style="width: 100%; height: 100%; object-fit: cover;">
                                </div>
                            `;
                        });
                        
                        // Videos
                        videos.forEach(videoUrl => {
                            mediaHTML += `
                                <div style="width: 100px; height: 100px; border-radius: 8px; overflow: hidden; border: 2px solid #e2e8f0; position: relative; cursor: pointer; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);" onclick="openVideoLightbox('${videoUrl}')">
                                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white; font-size: 32px;">
                                        <i class="fas fa-play-circle"></i>
                                    </div>
                                </div>
                            `;
                        });
                        
                        mediaHTML += '</div>';
                    }
                    
                    html += `
                    <div style="padding: 30px; border: 2px solid #f0f0f0; border-radius: 15px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 50px; height: 50px; border-radius: 50%; background: ${avatarColor}; display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 20px;">
                                    ${userInitial}
                                </div>
                                <div>
                                    <div style="font-weight: 600; color: #2c3e50; margin-bottom: 3px;">${userName}</div>
                                    <div style="color: #95a5a6; font-size: 13px;">${reviewDate}</div>
                                </div>
                            </div>
                            <div style="color: #f39c12; font-size: 16px;">
                                ${generateStars(review.rating)}
                            </div>
                        </div>
                        <div style="color: #555; line-height: 1.8;">
                            ${comment}
                        </div>
                        ${mediaHTML}
                    </div>
                    `;
                });
                html += '</div>';
            } else {
                html += renderNoReviewsHTML();
            }
            
            reviewsSection.innerHTML = html;
        }
        
        // Generate rating bars from stats
        function generateRatingBarsFromStats(stats) {
            const bars = [
                { label: '5 sao', count: stats.fiveStar || 0 },
                { label: '4 sao', count: stats.fourStar || 0 },
                { label: '3 sao', count: stats.threeStar || 0 },
                { label: '2 sao', count: stats.twoStar || 0 },
                { label: '1 sao', count: stats.oneStar || 0 }
            ];
            
            return bars.map(bar => {
                const percentage = stats.totalReviews > 0 ? (bar.count / stats.totalReviews) * 100 : 0;
                return `
                <div style="display: grid; grid-template-columns: 60px 1fr 40px; gap: 15px; align-items: center;">
                    <span style="color: #7f8c8d; font-size: 14px;">${bar.label}</span>
                    <div style="height: 8px; background: #e0e0e0; border-radius: 10px; overflow: hidden;">
                        <div style="height: 100%; background: linear-gradient(90deg, #f39c12 0%, #f1c40f 100%); width: ${percentage}%; transition: width 0.3s;"></div>
                    </div>
                    <span style="color: #7f8c8d; font-size: 14px; text-align: right;">${bar.count}</span>
                </div>
                `;
            }).join('');
        }
        
        // Render no reviews message
        function renderNoReviews() {
            const reviewsSection = document.getElementById('reviewsSection');
            reviewsSection.innerHTML = renderNoReviewsHTML();
        }
        
        function renderNoReviewsHTML() {
            return `
            <div style="text-align: center; padding: 60px 0;">
                <i class="fas fa-comment-slash" style="font-size: 64px; color: #e0e0e0; margin-bottom: 20px;"></i>
                <p style="color: #7f8c8d; font-size: 16px;">Chưa có đánh giá nào cho sản phẩm này.</p>
                <p style="color: #95a5a6; font-size: 14px; margin-top: 10px;">Hãy là người đầu tiên đánh giá sản phẩm!</p>
            </div>
            `;
        }

        // Attach event listeners
        function attachEventListeners() {
            // Image gallery
            document.querySelectorAll('.thumbnail').forEach((thumb, index) => {
                thumb.addEventListener('click', function() {
                    document.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    const img = this.querySelector('img').src;
                    document.getElementById('mainImage').src = img;
                });
            });

            // Color selection
            document.querySelectorAll('.color-option').forEach(color => {
                color.addEventListener('click', function() {
                    document.querySelectorAll('.color-option').forEach(c => c.classList.remove('active'));
                    this.classList.add('active');
                    const colorName = this.getAttribute('data-color');
                    document.getElementById('selectedColor').textContent = colorName;
                });
            });

            // Size selection
            document.querySelectorAll('.size-option:not(.out-of-stock)').forEach(size => {
                size.addEventListener('click', function() {
                    document.querySelectorAll('.size-option').forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                    const sizeName = this.getAttribute('data-size');
                    document.getElementById('selectedSize').textContent = sizeName;
                });
            });

            // Quantity controls
            const quantityInput = document.getElementById('quantityInput');
            if (quantityInput) {
                document.getElementById('decreaseBtn')?.addEventListener('click', () => {
                    if (quantityInput.value > 1) quantityInput.value--;
                });
                document.getElementById('increaseBtn')?.addEventListener('click', () => {
                    quantityInput.value++;
                });
            }

            // Wishlist toggle
            const wishlistBtn = document.querySelector('.btn-wishlist');
            if (wishlistBtn) {
                wishlistBtn.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const icon = this.querySelector('i');
                    icon.classList.toggle('far');
                    icon.classList.toggle('fas');
                });
            }

            // Add to cart
            const addCartBtn = document.querySelector('.btn-add-cart');
            if (addCartBtn && !addCartBtn.disabled) {
                addCartBtn.addEventListener('click', function() {
                    // Get selected size
                    const selectedSize = document.querySelector('.size-option.active');
                    if (!selectedSize) {
                        alert('Vui lòng chọn kích thước!');
                        return;
                    }
                    
                    // Find the variant ID based on selected size
                    const productId = getProductIdFromUrl();
                    const sizeValue = selectedSize.getAttribute('data-size');
                    
                    // Get quantity
                    const quantity = parseInt(document.getElementById('quantityInput').value) || 1;
                    
                    // Find variant by size (you'll need to store variants in a global variable)
                    if (window.currentProduct && window.currentProduct.variants) {
                        const variant = window.currentProduct.variants.find(v => v.size === sizeValue);
                        if (variant) {
                            // Use CartManager to add to cart
                            if (typeof CartManager !== 'undefined') {
                                CartManager.addToCart(variant.id, quantity);
                            } else {
                                // Fallback if cart.js is not loaded
                                console.error('CartManager not found');
                                alert('Có lỗi xảy ra. Vui lòng thử lại!');
                            }
                        } else {
                            alert('Không tìm thấy sản phẩm với kích thước đã chọn!');
                        }
                    }
                });
            }

            // Tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function() {
                    const tabName = this.dataset.tab;
                    
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    this.classList.add('active');
                    document.getElementById(tabName).classList.add('active');
                });
            });
        }

        // Show error
        function showError() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('errorState').style.display = 'block';
        }
        
        // Image Lightbox
        function openImageLightbox(imageUrl) {
            // Create lightbox overlay
            const lightbox = document.createElement('div');
            lightbox.id = 'imageLightbox';
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                border: none;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                font-size: 24px;
                cursor: pointer;
                z-index: 10001;
            `;
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                document.body.removeChild(lightbox);
            };
            
            lightbox.appendChild(img);
            lightbox.appendChild(closeBtn);
            lightbox.onclick = () => document.body.removeChild(lightbox);
            
            document.body.appendChild(lightbox);
        }
        
        // Video Lightbox
        function openVideoLightbox(videoUrl) {
            const lightbox = document.createElement('div');
            lightbox.id = 'videoLightbox';
            lightbox.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.9);
                z-index: 10000;
                display: flex;
                align-items: center;
                justify-content: center;
                cursor: pointer;
            `;
            
            const video = document.createElement('video');
            video.src = videoUrl;
            video.controls = true;
            video.autoplay = true;
            video.style.cssText = 'max-width: 90%; max-height: 90%; border-radius: 8px;';
            video.onclick = (e) => e.stopPropagation();
            
            const closeBtn = document.createElement('button');
            closeBtn.innerHTML = '<i class="fas fa-times"></i>';
            closeBtn.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: white;
                border: none;
                width: 50px;
                height: 50px;
                border-radius: 50%;
                font-size: 24px;
                cursor: pointer;
                z-index: 10001;
            `;
            closeBtn.onclick = (e) => {
                e.stopPropagation();
                document.body.removeChild(lightbox);
            };
            
            lightbox.appendChild(video);
            lightbox.appendChild(closeBtn);
            lightbox.onclick = () => document.body.removeChild(lightbox);
            
            document.body.appendChild(lightbox);
        }

        // Load product when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadProductDetail();
        });
    </script>
</th:block>